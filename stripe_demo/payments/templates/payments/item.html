<html>
  <head>
    <meta charset="utf-8" />
    <title>Buy {{ item.name }}</title>
  </head>
  <body>
    <h1>{{ item.name }}</h1>
    <p>{{ item.description }}</p>
    <p><b>Price:</b> {{ item.price }} (minor units), {{ item.currency|upper }}</p>

    <button id="buy-button">Buy</button>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
    const stripe = Stripe("{{ stripe_public_key }}");

    document.getElementById("buy-button").addEventListener("click", async () => {
      try {
        const resp = await fetch("/buy/{{ item.id }}/");

        if (!resp.ok) {
          const data = await resp.json();
          alert(data.error || "Buy failed");
          return;
        }

        let data;
        if (resp.headers.get("content-type")?.includes("application/json")) {
          data = await resp.json();
        } else {
          throw new Error("Server returned non-JSON response");
        }


        const result = await stripe.redirectToCheckout({
          sessionId: data.id,
        });

        if (result.error) {
          alert(result.error.message);
        }

      } catch (e) {
        alert(e.message || e);
      }
    });
  </script>
  </body>
</html>
