{% extends "payments/base.html" %}

{% block title %}Buy {{ item.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-9 col-lg-7">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <h1 class="h4 mb-2">{{ item.name }}</h1>
            <p class="text-muted mb-3">{{ item.description }}</p>
          </div>

          <span class="badge rounded-pill text-bg-dark align-self-start">
            {{ item.currency|upper }}
          </span>
        </div>

        <div class="price-box rounded-3 p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">Price</div>
            <div class="fs-4 fw-semibold">
              {{ item.price }} <span class="fs-6 text-muted">(minor units)</span>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button id="buy-button" class="btn btn-primary btn-lg flex-grow-1">
            Pay with Stripe
          </button>
          <a class="btn btn-outline-secondary btn-lg" href="/admin/payments/item/{{ item.id }}/change/">
            Edit
          </a>
        </div>

        <div class="mt-3 small text-muted">
          After clicking, you will be redirected to Stripe Checkout (test mode).
        </div>

        <div id="error-box" class="alert alert-danger mt-3 d-none" role="alert"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_public_key }}");
  const btn = document.getElementById("buy-button");
  const errBox = document.getElementById("error-box");

  function showError(msg) {
    errBox.textContent = msg || "Unexpected error";
    errBox.classList.remove("d-none");
  }

  btn.addEventListener("click", async () => {
    errBox.classList.add("d-none");
    btn.disabled = true;
    btn.textContent = "Creating checkout session...";

    try {
      const resp = await fetch("/buy/{{ item.id }}/", { method: "GET" });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        showError(data.error || "Failed to create Stripe Checkout Session");
        return;
      }

      const result = await stripe.redirectToCheckout({ sessionId: data.id });
      if (result && result.error) showError(result.error.message);
    } catch (e) {
      showError(e?.message || String(e));
    } finally {
      btn.disabled = false;
      btn.textContent = "Pay with Stripe";
    }
  });
</script>
{% endblock %}
