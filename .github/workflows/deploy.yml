name: "ðŸš€ Django Stripe Checkout"

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“‚ Checkout (metadata only)"
        uses: actions/checkout@v4

      - name: "ðŸ” SSH deploy"
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            DEPLOY_DIR="${{ secrets.DEPLOY_DIR }}"

            echo "Deploying to: $DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            # --- ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° main ---
            git fetch --all --prune
            git checkout main
            git reset --hard origin/main

            # --- Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼/Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ .env Ð¸Ð· GitHub Secrets ---
            cat > .env << 'EOF'
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DJANGO_DEBUG=0

            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

            STRIPE_PUBLIC_KEY_USD=${{ secrets.STRIPE_PUBLIC_KEY_USD }}
            STRIPE_SECRET_KEY_USD=${{ secrets.STRIPE_SECRET_KEY_USD }}
            STRIPE_PUBLIC_KEY_EUR=${{ secrets.STRIPE_PUBLIC_KEY_EUR }}
            STRIPE_SECRET_KEY_EUR=${{ secrets.STRIPE_SECRET_KEY_EUR }}
            EOF

            # --- Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· Makefile ---
            make build
            make up

            # --- ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ/Ð»Ð¾Ð³Ð¸ (ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾) ---
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
